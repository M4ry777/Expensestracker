import pandas as pd
import os
from flask import Flask, request, send_file, render_template_string

app = Flask(__name__)

# Store expenses in a list
data = []

HTML_TEMPLATE = """
<!doctype html>
<html>
<head><title>Expense Tracker</title></head>
<body>
    <h2>Record an Expense</h2>
    <form action="/add" method="post">
        Date: <input type="date" name="date" required><br>
        Category: <input type="text" name="category" required><br>
        Description: <input type="text" name="description" required><br>
        Amount: <input type="number" step="0.01" name="amount" required><br>
        <input type="submit" value="Add Expense">
    </form>
    <br>
    <form action="/download" method="get">
        <input type="submit" value="Download Excel File">
    </form>
</body>
</html>
"""

@app.route('/')
def home():
    return render_template_string(HTML_TEMPLATE)

@app.route('/add', methods=['POST'])
def add_expense():
    entry = {
        'Date': request.form['date'],
        'Category': request.form['category'],
        'Description': request.form['description'],
        'Amount': float(request.form['amount'])
    }
    data.append(entry)
    return "Expense added! <a href='/'>Go back</a>"

@app.route('/download')
def download():
    if not data:
        return "No expenses recorded yet. <a href='/'>Go back</a>"
    
    df = pd.DataFrame(data)
    file_path = "expenses.xlsx"
    with pd.ExcelWriter(file_path, engine='xlsxwriter') as writer:
        df.to_excel(writer, sheet_name='All Expenses', index=False)
        
        for category in df['Category'].unique():
            category_df = df[df['Category'] == category]
            category_df.to_excel(writer, sheet_name=category, index=False)
            
            worksheet = writer.sheets[category]
            worksheet.write(len(category_df) + 2, 0, 'Total Spent:')
            worksheet.write(len(category_df) + 2, 1, category_df['Amount'].sum())
    
    return send_file(file_path, as_attachment=True)

if __name__ == '__main__':
    app.run(debug=True)
